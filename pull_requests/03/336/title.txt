Further work on typestate_check