Make the macro system more modular.