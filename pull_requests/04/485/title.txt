Rewrite of task switching mechanism