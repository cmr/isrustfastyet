Pull some of the parts of trans_foreach into seperate functions