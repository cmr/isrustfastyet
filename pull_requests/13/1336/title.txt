misc fixes and library functions