Fix and test for issue #3780.