Begin refactoring deriving code and implement #[deriving(TotalOrd)]