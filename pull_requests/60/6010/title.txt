Fix leaks/undefined behavour in core::run on windows, and remove os::waitpid