Revert commits that caused a stack overflow on Mac