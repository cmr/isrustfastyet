More flexible and robust deriving code