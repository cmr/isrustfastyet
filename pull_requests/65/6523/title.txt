Rebase Tommy McGuire's each_permutation patch