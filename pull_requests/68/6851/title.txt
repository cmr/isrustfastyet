Refactor deriving(Encodable, Decodable) and various bugfixes