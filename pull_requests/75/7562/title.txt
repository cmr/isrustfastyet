Deque: fix an assertion, speed up and big cleanup