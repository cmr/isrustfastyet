Fix #7459, add #[bench] metric-capture and ratchets, activate codegen test ratchet